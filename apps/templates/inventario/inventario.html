{% extends "base/base.html" %}

{% block title %}Inventario{% endblock %}

{% block body_class %} sidebar-mini {% endblock body_class %}

{% block content %}

<style>
    .col-cantidad {
        width: 60px;
        max-width: 60px;
        text-align: center;
    }

    .col-operaciones {
        width: 100px;
        max-width: 100px;
        text-align: center;
    }

    .col-operaciones .btn {
        padding: 4px 6px;
        margin: 1px;
    }
</style>

<div class="card" style="width: 100%;">
    <div class="card-body">
        <h1>Inventario</h1>

        <div class="row p-3 card-title align-items-center">
            <div class="col-12 d-flex justify-content-md-end justify-content-center">
                <a class="btn btn-crear btn-sm"
                   href="{% url 'inventario:crear_inventario' %}">
                    <i class="bi bi-plus-circle"></i> Nuevo Registro
                </a>
            </div>
        </div>

        {% if items_page %}
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="text-center table-head-color">
                <tr>
                    <th style="color:white;">Nombre</th>
                    <th style="color:white;">Chico</th>
                    <th style="color:white;">Grande</th>
                    <th style="color:white;" class="col-operaciones"></th>
                </tr>
                </thead>

                <tbody>
                {% for obj in items_page %}
                <tr id="row-{{ obj.id }}">
                    <!-- NOMBRE -->
                    <td>
                        <input type="text"
                               class="form-control form-control-sm"
                               id="nombre-{{ obj.id }}"
                               value="{{ obj.nombre }}"
                               data-original="{{ obj.nombre }}"
                               disabled>
                    </td>

                    <!-- CANTIDAD CHICO-->
                    <td class="col-cantidad">
                        <input type="number"
                               class="form-control form-control-sm text-center"
                               id="cant_chico-{{ obj.id }}"
                               value="{{ obj.cant_chico }}"
                               data-original="{{ obj.cant_chico }}"
                               disabled>
                    </td>

                    <!-- CANTIDAD GRANDE-->
                    <td class="col-cantidad">
                        <input type="number"
                               class="form-control form-control-sm text-center"
                               id="cant_grande-{{ obj.id }}"
                               value="{{ obj.cant_grande }}"
                               data-original="{{ obj.cant_grande }}"
                               disabled>
                    </td>

                    <!-- OPERACIONES -->
                    <td class="col-operaciones">
                        <button class="btn btn-crear btn-sm"
                                id="edit-{{ obj.id }}"
                                onclick="habilitarEdicion({{ obj.id }})">
                            <i class="bi bi-pen"></i>
                        </button>

                        <button class="btn btn-crear btn-sm d-none"
                                id="save-{{ obj.id }}"
                                onclick="guardarEdicion({{ obj.id }})">
                            <i class="bi bi-check-lg"></i>
                        </button>

                        <button class="btn btn-secondary btn-sm d-none"
                                id="cancel-{{ obj.id }}"
                                onclick="cancelarEdicion({{ obj.id }})">
                            <i class="bi bi-x-lg"></i>
                        </button>

                        <a class="btn btn-cancelar btn-sm"
                           data-bs-toggle="modal"
                           data-bs-target="#confirmarEliminarModal{{ obj.id }}">
                            <i class="bi bi-trash"></i>
                        </a>

                        <!-- MODAL ELIMINAR -->
                        <div class="modal fade"
                             id="confirmarEliminarModal{{ obj.id }}"
                             tabindex="-1"
                             aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Confirmar eliminación</h5>
                                        <button class="btn-close"
                                                data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        ¿Estás seguro de que deseas eliminar este registro?
                                    </div>
                                    <div class="modal-footer">
                                        <button class="btn btn-secondary"
                                                data-bs-dismiss="modal">
                                            Cancelar
                                        </button>
                                        <a class="btn btn-danger"
                                           href="{% url 'inventario:eliminar_inventario' obj.id %}">
                                            Eliminar
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>

            {% include "base/pagination.html" with items_page=items_page %}
        </div>
        {% else %}
            {% include "base/sin_registro.html" %}
        {% endif %}
    </div>
</div>

<script>
function habilitarEdicion(id) {
    ["nombre", "cant_chico", "cant_grande"].forEach(campo => {
        document.getElementById(`${campo}-${id}`).disabled = false;
    });

    document.getElementById(`edit-${id}`).classList.add("d-none");
    document.getElementById(`save-${id}`).classList.remove("d-none");
    document.getElementById(`cancel-${id}`).classList.remove("d-none");
}

function cancelarEdicion(id) {
    ["nombre", "cant_chico", "cant_grande"].forEach(campo => {
        const input = document.getElementById(`${campo}-${id}`);
        input.value = input.dataset.original;
        input.disabled = true;
    });

    document.getElementById(`edit-${id}`).classList.remove("d-none");
    document.getElementById(`save-${id}`).classList.add("d-none");
    document.getElementById(`cancel-${id}`).classList.add("d-none");
}

function guardarEdicion(id) {
    const nombre = document.getElementById(`nombre-${id}`);
    const cant_chico = document.getElementById(`cant_chico-${id}`);
    const cant_grande = document.getElementById(`cant_grande-${id}`);

    fetch(`/inventario/editar/${id}/`, {
        method: "POST",
        headers: {
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({
            nombre: nombre.value,
            cant_chico: cant_chico.value,
            cant_grande: cant_grande.value,
            csrfmiddlewaretoken: "{{ csrf_token }}"
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            nombre.dataset.original = nombre.value;
            cant_chico.dataset.original = cant_chico.value;
            cant_grande.dataset.original = cant_grande.value;

            cancelarEdicion(id);
        } else {
            alert("Error al guardar");
        }
    });
}
</script>

{% endblock %}
